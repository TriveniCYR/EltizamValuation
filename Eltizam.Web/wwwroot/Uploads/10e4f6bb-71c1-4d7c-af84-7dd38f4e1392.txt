USE [EltizamDB_Dev]
GO
/****** Object:  StoredProcedure [dbo].[usp_Valution_GetValuationList]    Script Date: 11/2/2023 1:43:24 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 

-- exec [usp_Valution_GetValuationList]  0,20,0,'',''
ALTER PROCEDURE [dbo].[usp_Valution_GetValuationList] 
(
	@CurrentPageNumber INT = 0,            
	@PageSize INT = 10,            
	@SortColumn VARCHAR(100) = 'Id',            
	@SortDirection VARCHAR(5) = 'ASC',            
	@SearchText VARCHAR(MAX) = NULL
)        
AS          
BEGIN     
	DECLARE @Letter VARCHAR(MAX) = @SearchText; --ISNULL(@SearchText, '')

	SELECT * FROM 
	(
	SELECT
	COUNT(VR.[Id]) OVER() TotalRecord, ROW_NUMBER() OVER (ORDER BY VR.Id ASC) TotalFilterCount,
		   VR.Id, C.ClientName, CT.ClientType, MS.StateName AS Location, P.PropertyName, VR.ValuationDate,P.ValuationPurpose,VRS.StatusName,
		   MU.UserName AS Approver,MR.UserName AS Requestor,MRU.UserName AS Valuator,MDD.Description AS MethodOfValution,VS.ColorCode,VR.ReferenceNO
    FROM [dbo].[ValuationRequest] VR
    INNER JOIN Master_Client C ON VR.ClientId = C.Id
    INNER JOIN Master_ClientType CT ON C.ClientTypeId = CT.Id
    INNER JOIN Master_Property P ON VR.PropertyId = P.Id
	INNER JOIN ValuationRequestStatus VRS ON VR.StatusId=VRS.ID
	INNER JOIN Master_User MU ON VR.ApproverId=MU.Id
	INNER JOIN Master_User MR ON VR.CreatedBy=MR.Id
	INNER JOIN Master_User MRU ON VR.ModifyBy=MRU.Id
	LEFT JOIN Master_DictionaryDetail MDD ON MDD.Id=VR.ValuerId 
	LEFT JOIN Master_Dictionary MD ON MD.Id=MDD.DictionaryId and MD.DictionaryCode='ValuationMethod'

	INNER JOIN Master_Property_Location PL ON VR.PropertyId=PL.PropertyID
	INNER JOIN Master_State MS ON PL.StateId=MS.ID
	LEFT JOIN ValuationRequestStatus VS ON VS.ID=VR.StatusId

		WHERE 1 = 1  
			  AND (@Letter IS NULL  OR (C.ClientName LIKE '%'+@Letter+'%'))
	) Res

	WHERE TotalFilterCount BETWEEN (@CurrentPageNumber) + 1  AND (@CurrentPageNumber) + @PageSize  
	
	ORDER BY 
			CASE WHEN @SortDirection = 'DESC' AND @SortColumn = 'Id' THEN  Id  END DESC,
			CASE WHEN @SortDirection = 'ASC'  AND @SortColumn = 'Id' THEN  Id  END ASC,
			CASE WHEN @SortDirection = 'DESC' AND @SortColumn = 'ClientName' THEN  ClientName  END DESC,
			CASE WHEN @SortDirection = 'ASC'  AND @SortColumn = 'ClientName' THEN  ClientName  END ASC,
			CASE WHEN @SortDirection = 'DESC' AND @SortColumn = 'PropertyName' THEN  PropertyName  END DESC,
			CASE WHEN @SortDirection = 'ASC'  AND @SortColumn = 'PropertyName' THEN  PropertyName  END ASC 
			  
END 

